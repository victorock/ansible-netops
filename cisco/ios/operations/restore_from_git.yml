- name: "IOS Restore"
  hosts: ios
  connection: network_cli
  gather_facts: no

  vars:
    restore_repo: ssh://git@github.com/victorock/network-configs
    restore_branch: "snapshot"

  tasks:

    - name: "create temporary directory to store configuration"
      run_once: true
      changed_when: false
      tempfile:
        state: directory
        suffix: ios_config
      register: r_tempfile

    - name: "clone the repository containing configurations"
      run_once: true
      changed_when: false
      git:
        accept_hostkey: true
        repo: "{{ restore_repo }}"
        dest: "{{ r_tempfile.path }}"
        version: "{{ restore_branch }}"
        clone: yes

    - name: "Put configuration into router"
      vars:
        ansible_command_timeout: 650
      net_put:
        src: "{{ r_tempfile.path }}/{{ inventory_hostname }}/config/running.cfg"
        dest: "{{ inventory_hostname }}.config"

    - name: "Replace router's configuration"
      vars:
        ansible_command_timeout: 650
      ios_command:
        commands:
          - "config replace {{ inventory_hostname }}.config force ignorecase time 10"

    - name: "configure confirm"
      ios_command:
        commands:
          - "configure confirm"

    - name: "Cleanup generated files/directories"
      run_once: true
      changed_when: false
      file:
        path: "{{ r_tempfile.path }}"
        state: absent