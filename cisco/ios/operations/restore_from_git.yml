- name: "IOS Restore"
  hosts: ios
  connection: network_cli
  gather_facts: no

  vars:
    restore_repo: ssh://git@github.com/victorock/network-configs
    restore_branch: "{{ backup_branch }}"

  tasks:

    - name: "create temporary directory to store configuration"
      run_once: true
      changed_when: false
      tempfile:
        state: directory
        suffix: ios_config
      register: r_tempfile

    - name: "clone the repository containing configurations"
      run_once: true
      changed_when: false
      git:
        accept_hostkey: true
        repo: "{{ restore_repo }}"
        dest: "{{ r_tempfile.path }}"
        version: "{{ restore_branch }}"
        clone: yes

    - name: "Enable scp server"
      ios_config:
        lines:
          - "ip scp server enable"

#    - name: "Put configuration into router"
#      vars:
#        ansible_command_timeout: 650
#      net_put:
#        mode: "text"
#        protocol: "scp"
#        src: "{{ r_tempfile.path }}/{{ inventory_hostname }}/config/running.cfg"
#        dest: "{{ restore_branch }}.cfg"

    - name: "scp copy"
      command: scp -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no {{ r_tempfile.path }}/{{ inventory_hostname }}/config/running.cfg {{ ansible_user }}@{{ ansible_host }}:/{{ restore_branch }}.cfg

    - name: "Replace router's configuration"
      vars:
        ansible_command_timeout: 650
      ios_command:
        commands:
          - "config replace flash:/{{ restore_branch }}.cfg force revert trigger time 10"

    - name: "configure confirm"
      ios_command:
        commands:
          - "configure confirm"

    - name: "Cleanup generated files/directories"
      run_once: true
      changed_when: false
      file:
        path: "{{ r_tempfile.path }}"
        state: absent